<!DOCTYPE html>
<meta charset="utf-8">
<html>

<head>
  <title>MainPage</title>
  <script src="d3.min.js"></script>
  <script src="d3-v6-tip.js"></script>
  <script src="jquery-3.4.1.min.js"></script>
  <script src="echarts.min.js"></script>
  <script src="echarts-wordcloud.js"></script>
  <script src="echarts-wordcloud.min.js"></script>
  <link rel="stylesheet" href="d3-tip.css">
</head>

<body>
    <div class="header">
        <p>a</p>
    </div>
    <section class="main">
        <div class="column">
            <div id="lefttopdiv">
                <p>a</p>
            </div>
            <div id="leftmiddiv" style="background-color:pink;">
                <p>a</p>
            </div>
            <div id="leftbotdiv" style="background-color:pink;">
                <p>a</p>
            </div>
        </div>

        <div class="column">
            <div id="maintable"></div>
            <table id="table">
                <tr clas="tr">
                <th>排名</th>
                <th>学校</th>
                <th>英文名</th>
                <th>总分</th>
                </tr>
                <!-- </th> -->
            </table>
        </div>

        <div class="column">
            <div id="righttopdiv" style="background-color:pink;">
                <p>a</p>
            </div>
            <div id="rightmiddiv" style="background-color:pink;">
                <p>a</p>
            </div>
            <div id="rightbotdiv" style="background-color:pink;">
                <p>a</p>
            </div>
        </div>
    </section>
</body>

<style type="text/css">
    .header {
        background-color: blue;
        height: 12vh;
    }
    .main {
        display: flex;
        height: 85vh;
        margin-top: 3vh;
    }
    .main .column {
        flex: 3;
        background-color: green;
    }
    .main .column:nth-child(2) {
        flex: 6;
        margin: 1 0.125rem 0.1875rem;
        overflow:auto;
        background-color: red;
    }
    .column #lefttopdiv {
        background-color: pink;
        min-height: 30vh;
    }
    .column #leftmiddiv {
        background-color: pink;
        min-height: 30vh;
    }
    .column #leftbotdiv {
        background-color: pink;
        min-height: 30vh;
    }
    .column #righttopdiv {
        background-color: pink;
        min-height: 30vh;
    }
    .column #rightmiddiv {
        background-color: pink;
        min-height: 30vh;
    }
    .column #rightbotdiv {
        background-color: pink;
        min-height: 30vh;
    }
    .column #maintable {
        font-size: 15px;
        font-weight: bolder;
        align-items: center;
    }
    .tr {
        color: yellow;
        text-align: center;
    }
    .tr:hover {
        color: darkred;
        /* text-align: center; */
        background-color: orange;
    }
    .tr-clicked {
        color: blue;
        background-color: green;
    }
    .tr:focus {
        color: blue;
        background-color: gray;
    }
    .td-name {
        border: 3px solid gold;
    }
    .td-name-en {
        border: 3px solid gold;
    }
    .td-score {
        border: 3px solid gold;
    }
    .td-rank {
        border: 3px solid gold;
    }
</style>
<script>
    var majorChart;
    var majorData;
    var majorOption;
    var cloudData;
    var cloudOption;
    // 专业比重
    var year = "2023"
    var majorData = {};
    var schoolname = "南开大学"
    d3.json('../data/专业排名.json').then(function (jsonData) {
        majorData = jsonData;
        var schoolselect = document.getElementById('leftmiddiv');
        var target_school = majorData.find(function(item){
            return item.name === schoolname
        })
        
        var target_mode = target_school['ranked-disciplines']
        
        var Names = ['A+','A','A-','B+','B','B-','C+','C','C-']
        var counts = [0,0,0,0,0,0,0,0,0]
        target_mode.forEach(element => {
            for(var i=0;i<9;i++){
                if(element.rank === Names[i])counts[i] = counts[i]+1
            }
            return
        });

        var fnames = []
        var fcounts = []

        for(var i=0;i<9;i++){
            if(counts[i] != 0){
                fnames.push(Names[i])
                fcounts.push(counts[i])
            }
        }

        var datas = []
        for(var i=0;i<fnames.length;i++){
            var data = {}
            data['value'] = fcounts[i]
            data['name'] = fnames[i]
            datas.push(data)
        }

        majorChart = echarts.init(schoolselect);
        majorOption = {
            title: {
                text: schoolname,
                subtext: year,
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b} : {c} ({d}%)'
            },
            legend: {
                left: 'center',
                top: 'bottom',
                data: fnames
            },
            toolbox: {
                show: true,
                feature: {
                mark: { show: true },
                dataView: { show: true, readOnly: false },
                restore: { show: true },
                saveAsImage: { show: true }
                }
            },
            series: [
                {
                name: 'Area Mode',
                type: 'pie',
                radius: [20, 100],
                center: ['50%', '50%'],
                roseType: 'radius',
                itemStyle: {
                    borderRadius: 5
                },
                data: datas
                }
            ]
        };
        majorOption && majorChart.setOption(majorOption);

// 词云
        var schoolselect = document.getElementById('lefttopdiv');
        var target_school = jsonData.find(function (item) {
            return item.name === schoolname
        })

        var target_mode = target_school['ranked-disciplines'];
        var cnt = 0;
        var value_range = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-'];

        var disciplines_filtered = [];
        for (i in target_mode) {
            var item = target_mode[i];
            if (item.rank == "A+" || item.rank == "A" || item.rank == "A-" || item.rank == "B+"
            || item.rank == "B" || item.rank == "B-") {
            disciplines_filtered.push(item);
            }
        }
        wordData = disciplines_filtered.map(function (item) {
            function get_weight(rank) {
            if (rank == "A+") {
                return 100;
            }
            else if (rank == "A") {
                return 95;
            }
            else if (rank == "A-") {
                return 90;
            }
            else if (rank == "B+") {
                return 85;
            }
            else if (rank == "B") {
                return 80;
            }
            else if (rank == "B-") {
                return 75;
            }
            else if (rank == "C+") {
                return 70;
            }
            return 60;
            }
            return {
            name: item.class,
            value: get_weight(item.rank)
            }
        })
        console.log("here");
        console.log(wordData);
        cloudChart = echarts.init(schoolselect);

        cloudOption = {
            series: [{
            type: "wordCloud",
            shape: "circle",
            gridSize: 10,
            sizeRange: [6, 15],
            rotationRange: [-90, 90],
            textStyle: {
                normal: {
                fontFamily: "Arial, sans-serif",
                color: function () {
                    return 'rgb(' + [
                    Math.round(Math.random() * 160),
                    Math.round(Math.random() * 160),
                    Math.round(Math.random() * 160)
                    ].join(',') + ')';
                }
                }
            },
            emphasis: {
                textStyle: {
                fontWeight: "bold"
                }
            },
            data: wordData
            }]
        };

        cloudChart.setOption(cloudOption);
    });

    // 总榜
    d3.json("../data/中国大学及评价.json").then(function(json) {
        console.log(json);
        var box = document.getElementById('maintable');
        var ul = document.getElementById('table');
        for (var i = 0; i < json.length; i += 1) {
            var li = document.createElement('tr');
            li.className = "tr";
            ul.appendChild(li);
            
            var td = document.createElement('td');
            td.className = "td-rank";
            li.append(td);
            td.innerHTML = "<p>" + json[i]["rank"]; + "</p>";
            td = document.createElement('td');
            td.className = "td-name";
            li.append(td);
            td.innerHTML = "<p>" + json[i]["name"]; + "</p>";
            td = document.createElement('td');
            td.className = "td-name-en";
            li.append(td);
            td.innerHTML = "<p>" + json[i]["name-en"]; + "</p>";
            td = document.createElement('td');
            td.className = "td-score";
            li.append(td);
            td.innerHTML = "<p>" + json[i]["tot-score"]; + "</p>";
        }
        $(".tr").click(function() {
            schoolname = $(this).children("td")[1].textContent
            console.log(schoolname);
            $(this).toggleClass("tr-clicked");

            var target_school = majorData.find(function(item){
                return item.name === schoolname
            })
            
            var target_mode = target_school['ranked-disciplines']
            
            var Names = ['A+','A','A-','B+','B','B-','C+','C','C-']
            var counts = [0,0,0,0,0,0,0,0,0]
            target_mode.forEach(element => {
                for(var i=0;i<9;i++){
                    if(element.rank === Names[i])counts[i] = counts[i]+1
                    // if(element.rank === 'B')console.log(element.class)
                }
                return
            });

            var fnames = []
            var fcounts = []

            for(var i=0;i<9;i++){
                if(counts[i] != 0){
                    fnames.push(Names[i])
                    fcounts.push(counts[i])
                }
            }

            var datas = []
            for(var i=0;i<fnames.length;i++){
                var data = {}
                data['value'] = fcounts[i]
                data['name'] = fnames[i]
                datas.push(data)
            }

            
            majorOption.title.text = schoolname;
            majorOption.series[0].data = datas;
            majorChart.setOption(majorOption);


            var target_school = majorData.find(function (item) {
                return item.name === schoolname
            })

            var target_mode = target_school['ranked-disciplines'];
            var cnt = 0;
            var value_range = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-'];

            var disciplines_filtered = [];
            for (i in target_mode) {
                var item = target_mode[i];
                if (item.rank == "A+" || item.rank == "A" || item.rank == "A-" || item.rank == "B+"
                || item.rank == "B" || item.rank == "B-") {
                disciplines_filtered.push(item);
                }
            }
            wordData = disciplines_filtered.map(function (item) {
                function get_weight(rank) {
                if (rank == "A+") {
                    return 100;
                }
                else if (rank == "A") {
                    return 95;
                }
                else if (rank == "A-") {
                    return 90;
                }
                else if (rank == "B+") {
                    return 85;
                }
                else if (rank == "B") {
                    return 80;
                }
                else if (rank == "B-") {
                    return 75;
                }
                else if (rank == "C+") {
                    return 70;
                }
                return 60;
                }
                return {
                name: item.class,
                value: get_weight(item.rank)
                }
            })
            console.log(wordData);
            cloudOption.data = wordData;
            cloudChart.setOption(cloudOption);
        })
    });
</script>
</html>